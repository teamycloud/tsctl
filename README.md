
tsctl: tinyscale ç”¨æˆ·ä¾§ CLI
==================

## æ¦‚è¿°

æœ¬é¡¹ç›®ä¸º tinyscale å¹³å°æä¾›å®¢æˆ·ç«¯å·¥å…·ï¼ŒåŒ…å«ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼š

1. **tsctl** - å®¢æˆ·ç«¯å‘½ä»¤è¡Œå·¥å…·
2. **guest** - è¿œç¨‹ä¸»æœºä¸Šçš„ agent æœåŠ¡
3. **connector** - mTLS è¿æ¥ä»£ç†ï¼ˆè®¡åˆ’ä¸­ï¼‰

`tsctl` çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªæ™ºèƒ½çš„ Docker API ä»£ç†ç¨‹åºï¼Œå°†æœ¬åœ° Docker CLI è°ƒç”¨é€æ˜åœ°è½¬å‘åˆ°è¿œç¨‹ä¸»æœºï¼ŒåŒæ—¶è‡ªåŠ¨è§£å†³ä¸¤ä¸ªå…³é”®æŒ‘æˆ˜ï¼š

### å…³é”®ç‰¹æ€§

* **è‡ªåŠ¨ç«¯å£è½¬å‘** - æ— éœ€æ‰‹åŠ¨é…ç½®ç«¯å£æ˜ å°„
* **æœ¬åœ°â†’è¿œç¨‹æ–‡ä»¶åŒæ­¥** - å®æ—¶åŒæ­¥ bind mount ç›®å½•  
* **åŒä¼ è¾“æ”¯æŒ** - æ”¯æŒ SSH å’Œ mTLS (ts-tunnel) ä¸¤ç§ä¼ è¾“æ–¹å¼
* **é›¶é…ç½®ä½“éªŒ** - è‡ªåŠ¨æ‹¦æˆªå’Œå¤„ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

### å·¥ä½œåŸç†

1. **è‡ªåŠ¨ç«¯å£è½¬å‘**
   - æ‹¦æˆªå®¹å™¨åˆ›å»ºè¯·æ±‚ï¼Œè§£æ `-p 8080:80` å‚æ•°
   - ä½¿ç”¨ Mutagen çš„è½¬å‘åè®®åˆ›å»ºç«¯å£è½¬å‘ä¼šè¯
   - åœ¨å®¹å™¨å¯åŠ¨æ—¶æ¿€æ´»è½¬å‘ï¼Œåœæ­¢æ—¶è‡ªåŠ¨æ¸…ç†
   - æ”¯æŒå¤šç«¯å£å’Œ TCP/UDP åè®®

2. **æ™ºèƒ½æ–‡ä»¶åŒæ­¥**
   - æ£€æµ‹ `-v ./src:/app` ç±»å‹çš„ bind mount
   - ä½¿ç”¨ Mutagen çš„åŒæ­¥åè®®å»ºç«‹åŒå‘æ–‡ä»¶åŒæ­¥
   - å¢é‡åŒæ­¥ï¼Œæ”¯æŒå¿½ç•¥æ¨¡å¼å’Œæ–‡ä»¶ç›‘æ§
   - å®¹å™¨åœæ­¢æ—¶è‡ªåŠ¨æ¸…ç†åŒæ­¥ä¼šè¯

é¡¹ç›®å¤„äºæ´»è·ƒå¼€å‘é˜¶æ®µï¼Œæ ¸å¿ƒåŠŸèƒ½å·²å®ç°ã€‚

## æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Docker CLI  â”‚â”€â”€TCPâ”€â†’â”‚  tsctl (Proxy)   â”‚â”€â”€â”€â”€â”€â”€â”€â”‚  Transport  â”‚â”€â”€â”€â”€â”€â”€â†’â”‚ Remote Host  â”‚
â”‚             â”‚       â”‚  HTTP-Aware      â”‚       â”‚  SSH/mTLS   â”‚       â”‚  + Docker    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”œâ”€ HTTP Parser & Interceptor
                            â”œâ”€ Container Lifecycle Manager
                            â”œâ”€ Port Forward Manager (Mutagen)
                            â””â”€ File Sync Manager (Mutagen)
```

### ç»„ä»¶è¯´æ˜

#### 1. tsctl (å®¢æˆ·ç«¯)

**cmd/tsctl/main.go**
- CLI å…¥å£ï¼Œä½¿ç”¨ Cobra æ¡†æ¶
- æä¾› `start` å’Œ `host-exec` å­å‘½ä»¤

**pkg/docker-api-proxy/**
- `tcp_proxy.go` - HTTP-aware TCP ä»£ç†æ ¸å¿ƒ
- `port_forward.go` - ç«¯å£è½¬å‘ç®¡ç†ï¼ˆåŸºäº Mutagenï¼‰
- `file_sync.go` - æ–‡ä»¶åŒæ­¥ç®¡ç†ï¼ˆåŸºäº Mutagenï¼‰
- `ssh_client.go` - SSH ä¼ è¾“å®ç°
- `types.go` - é…ç½®ç±»å‹å®šä¹‰

**pkg/ts-tunnel/**
- è‡ªå®šä¹‰ mTLS ä¼ è¾“åè®®å®ç°
- `agent-transport/` - Mutagen agent ä¼ è¾“å±‚
- `forwarding-protocol/` - è½¬å‘åè®®å¤„ç†å™¨
- `synchronization-protocol/` - åŒæ­¥åè®®å¤„ç†å™¨

#### 2. guest (è¿œç¨‹ agent)

**cmd/guest/main.go**
- è¿œç¨‹ä¸»æœºä¸Šçš„ agent æœåŠ¡
- ç›‘å¬ HTTP è¯·æ±‚ï¼Œæä¾›å‘½ä»¤æ‰§è¡Œå’Œæ–‡ä»¶æ‹·è´åŠŸèƒ½

**pkg/guest/**
- `server.go` - HTTP æœåŠ¡å™¨ï¼Œä¼˜é›…åœæœº
- `command.go` - å‘½ä»¤æ‰§è¡Œå¤„ç†ï¼ˆHTTP UPGRADE åˆ° TCPï¼‰
- `copy.go` - æ–‡ä»¶æ‹·è´å¤„ç†ï¼ˆæ”¯æŒ gzip å‹ç¼©ï¼‰

æ”¯æŒçš„ç«¯ç‚¹ï¼š
- `/tinyscale/v1/host-exec/command` - å‘½ä»¤æ‰§è¡Œ
- `/tinyscale/v1/host-exec/copy` - æ–‡ä»¶ä¸Šä¼ 

## åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

- **åŒä¼ è¾“æ”¯æŒ**: 
  - SSH ä¼ è¾“ - ä¼ ç»Ÿ SSH éš§é“æ–¹å¼
  - TS-Tunnel ä¼ è¾“ - åŸºäº mTLS çš„è‡ªå®šä¹‰åè®®
- **HTTP Keep-Alive æ”¯æŒ**: åœ¨åŒä¸€ TCP è¿æ¥ä¸Šå¤„ç†å¤šä¸ª HTTP è¯·æ±‚
- **æ™ºèƒ½è¯·æ±‚æ‹¦æˆª**: è‡ªåŠ¨è§£æå’Œæ‹¦æˆªå®¹å™¨ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ API è°ƒç”¨
- **åè®®å‡çº§æ£€æµ‹**: è‡ªåŠ¨åˆ‡æ¢åˆ°é€æ˜ TCP æ¨¡å¼æ”¯æŒ attachã€exec ç­‰æ“ä½œ
- **è‡ªåŠ¨ç«¯å£è½¬å‘**: 
  - åŸºäº Mutagen çš„è½¬å‘åè®®
  - æ”¯æŒ TCP å’Œ UDP
  - å®¹å™¨åœæ­¢æ—¶è‡ªåŠ¨æ¸…ç†
- **è‡ªåŠ¨æ–‡ä»¶åŒæ­¥**:
  - åŸºäº Mutagen çš„åŒæ­¥åè®®
  - åŒå‘å¢é‡åŒæ­¥
  - æ”¯æŒæ–‡ä»¶ç›‘æ§å’Œå¿½ç•¥æ¨¡å¼
- **ä¼˜é›…åœæœº**: æ­£ç¡®å¤„ç†è¿›ç¨‹å’Œè¿æ¥çš„æ¸…ç†

### æ”¯æŒçš„ Docker API ç«¯ç‚¹

æ‹¦æˆªå’Œå¤„ç†çš„å…³é”®ç«¯ç‚¹ï¼š

- `POST /containers/create` - æå–ç«¯å£ç»‘å®šå’Œ bind mount é…ç½®
- `POST /containers/{id}/start` - æ¿€æ´»ç«¯å£è½¬å‘å’Œæ–‡ä»¶åŒæ­¥
- `POST /containers/{id}/stop` - å¼€å§‹æ¸…ç†æµç¨‹
- `DELETE /containers/{id}` - å®Œæˆæ¸…ç†
- `POST /containers/{id}/wait` - ç­‰å¾…å®¹å™¨é€€å‡ºå¹¶è§¦å‘æ¸…ç†
- `POST /containers/{id}/attach` - é€æ˜ä»£ç†ï¼ˆè¿æ¥å‡çº§ï¼‰

### ä¼ è¾“æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | SSH ä¼ è¾“ | TS-Tunnel (mTLS) |
|------|---------|------------------|
| è®¤è¯æ–¹å¼ | SSH å¯†é’¥ | mTLS è¯ä¹¦ |
| ç«¯å£è½¬å‘ | âœ… | âœ… |
| æ–‡ä»¶åŒæ­¥ | âœ… | âœ… |
| SNI è·¯ç”± | âŒ | âœ… |
| è´Ÿè½½å‡è¡¡ | å›°éš¾ | å®¹æ˜“ |
| å®‰å…¨éš”ç¦» | ç”¨æˆ·å¯ SSH ç™»å½• | åªèƒ½ API è®¿é—® |
| é…ç½®å¤æ‚åº¦ | ä¸­ç­‰ | éœ€è¦è¯ä¹¦ç®¡ç† |

## ä½¿ç”¨æ–¹æ³•

### 1. ä½¿ç”¨ SSH ä¼ è¾“

```bash
# å¯åŠ¨ä»£ç†
tsctl start \
  --listen 127.0.0.1:2375 \
  --ssh-user root \
  --ssh-host remote.example.com:22 \
  --ssh-key ~/.ssh/id_rsa \
  --remote-docker unix:///var/run/docker.sock

# é…ç½® Docker CLI
export DOCKER_HOST=tcp://127.0.0.1:2375

# æ­£å¸¸ä½¿ç”¨ Docker å‘½ä»¤
docker ps
docker run -p 8080:80 -v $(pwd):/app nginx
```

### 2. ä½¿ç”¨ TS-Tunnel (mTLS)

```bash
# å¯åŠ¨ä»£ç†
tsctl start \
  --listen 127.0.0.1:2375 \
  --ts-server containers.tinyscale.net:443 \
  --ts-cert /path/to/client.crt \
  --ts-key /path/to/client.key \
  --ts-ca /path/to/ca.crt \
  --remote-docker unix:///var/run/docker.sock

# é…ç½® Docker CLI
export DOCKER_HOST=tcp://127.0.0.1:2375

# æ­£å¸¸ä½¿ç”¨
docker run -it hello-world
```

### 3. è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

```bash
# åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œå‘½ä»¤
tsctl host-exec \
  --server-addr remote.host:8080 \
  --cert /path/to/client.crt \
  --key /path/to/client.key \
  -- ls -la /tmp

# å¸¦ç¯å¢ƒå˜é‡æ‰§è¡Œ
tsctl host-exec \
  --server-addr remote.host:8080 \
  --insecure \
  -e "FOO=bar" \
  -e "BAZ=qux" \
  -- env
```

### 4. éƒ¨ç½² Guest Agent

åœ¨è¿œç¨‹ä¸»æœºä¸Šï¼š

```bash
# å¯åŠ¨ guest agent
guest --port 8080

# æˆ–æŒ‡å®šä¸åŒç«¯å£
guest -p 9090
```

### é…ç½®å‚æ•°è¯´æ˜

#### tsctl start å‘½ä»¤

**SSH ä¼ è¾“å‚æ•°ï¼š**
- `--listen` - æœ¬åœ°ç›‘å¬åœ°å€ï¼ˆé»˜è®¤ï¼š127.0.0.1:2375ï¼‰
- `--ssh-user` - SSH ç”¨æˆ·åï¼ˆé»˜è®¤ï¼šrootï¼‰
- `--ssh-host` - SSH ä¸»æœºå’Œç«¯å£
- `--ssh-key` - SSH ç§é’¥è·¯å¾„
- `--remote-docker` - è¿œç¨‹ Docker socket åœ°å€
  - Unix socket: `unix:///var/run/docker.sock`
  - TCP: `tcp://127.0.0.1:2375`

**TS-Tunnel å‚æ•°ï¼š**
- `--ts-server` - Tinyscale æœåŠ¡å™¨åœ°å€
- `--ts-cert` - å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„
- `--ts-key` - å®¢æˆ·ç«¯ç§é’¥è·¯å¾„
- `--ts-ca` - CA è¯ä¹¦è·¯å¾„ï¼ˆå¯é€‰ï¼‰
- `--ts-insecure` - è·³è¿‡ TLS éªŒè¯ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰

**é€šç”¨å‚æ•°ï¼š**
- `--log-level` - æ—¥å¿—çº§åˆ«ï¼ˆinfo, debug, errorï¼‰


## æŠ€æœ¯å®ç°ç»†èŠ‚

### Docker API å¤„ç†æµç¨‹

å®¹å™¨å¯åŠ¨æ¶‰åŠçš„å…³é”® API è°ƒç”¨ï¼š

1. `HEAD /_ping` - å¥åº·æ£€æŸ¥
2. `POST /containers/create` - åˆ›å»ºå®¹å™¨ï¼ˆæ‹¦æˆªç‚¹ 1ï¼‰
3. `POST /containers/{id}/attach` - é™„åŠ åˆ°å®¹å™¨ï¼ˆè¿æ¥å‡çº§ï¼‰
4. `POST /containers/{id}/wait` - ç­‰å¾…å®¹å™¨é€€å‡ºï¼ˆé•¿è¿æ¥ï¼‰
5. `POST /containers/{id}/start` - å¯åŠ¨å®¹å™¨ï¼ˆæ‹¦æˆªç‚¹ 2ï¼‰

### å®ç°è¦ç‚¹

1. **è¿æ¥å¤ç”¨**
   - æœåŠ¡å™¨é»˜è®¤ä½¿ç”¨ HTTP/1.1 Keep-Alive
   - åŒä¸€è¿æ¥å¯å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ˆå¦‚ ping å’Œ createï¼‰
   - éœ€è¦æ­£ç¡®è§£ææ¯ä¸ª HTTP è¯·æ±‚/å“åº”

2. **è¿æ¥å‡çº§å¤„ç†**
   - `attach` è¯·æ±‚å¸¦æœ‰ `Upgrade: tcp` å¤´
   - æœåŠ¡å™¨è¿”å› `101 Switching Protocols`
   - ä¹‹ååˆ‡æ¢ä¸ºåŸå§‹ TCP æµ

3. **é•¿è¿æ¥å¤„ç†**
   - `wait` ç«¯ç‚¹ä½¿ç”¨ `Transfer-Encoding: chunked`
   - ä¸èƒ½å®Œæ•´è¯»å– response bodyï¼Œä¼šå¯¼è‡´é˜»å¡
   - éœ€è¦æµå¼å¤„ç†å“åº”

4. **è¯·æ±‚é¡ºåº**
   - `start` å¿…é¡»åœ¨ `wait` å“åº”å¤´æ”¶åˆ°åå‘é€
   - å¦åˆ™ä¼šå¯¼è‡´å®¹å™¨åˆ›å»ºä½†æœªå¯åŠ¨

### ç«¯å£è½¬å‘å®ç°

ä½¿ç”¨ Mutagen çš„è½¬å‘åè®®ï¼š

```go
// åˆ›å»ºè½¬å‘ä¼šè¯
source := "tcp:localhost:8080"
destination := "ssh://user@host:tcp:localhost:8080"
// æˆ– TS-Tunnel
destination := "ts://server/tcp:localhost:8080?cert=...&key=..."
```

ç”Ÿå‘½å‘¨æœŸï¼š
- å®¹å™¨ create æ—¶è®°å½•ç«¯å£ç»‘å®š
- å®¹å™¨ start æ—¶åˆ›å»ºè½¬å‘ä¼šè¯
- å®¹å™¨ stop/remove æ—¶æ¸…ç†ä¼šè¯

### æ–‡ä»¶åŒæ­¥å®ç°

ä½¿ç”¨ Mutagen çš„åŒæ­¥åè®®ï¼š

```go
// åˆ›å»ºåŒæ­¥ä¼šè¯
alpha := "/local/path"
beta := "ssh://user@host/remote/path"
// æˆ– TS-Tunnel
beta := "ts://server/remote/path?cert=...&key=..."
```

ç‰¹æ€§ï¼š
- åŒå‘å¢é‡åŒæ­¥
- æ”¯æŒ .gitignore é£æ ¼çš„å¿½ç•¥è§„åˆ™
- æ–‡ä»¶ç›‘æ§è‡ªåŠ¨åŒæ­¥å˜æ›´

### TS-Tunnel åè®®

è‡ªå®šä¹‰çš„ mTLS ä¼ è¾“åè®®ï¼ŒåŒ…å«ä¸‰å±‚ï¼š

1. **Transport å±‚** (`pkg/ts-tunnel/agent-transport/`)
   - å®ç° Mutagen çš„ `agent.Transport` æ¥å£
   - æä¾› TLS è¿æ¥å»ºç«‹å’Œç®¡ç†
   - æ”¯æŒå‘½ä»¤æ‰§è¡Œå’Œæ–‡ä»¶æ‹·è´

2. **Protocol å±‚** 
   - Forwarding Protocol (`forwarding-protocol/`)
   - Synchronization Protocol (`synchronization-protocol/`)
   - æ³¨å†Œåˆ° Mutagen çš„åè®®å¤„ç†å™¨

3. **URL è§£æ** (`url.go`)
   - è§£æ `ts://` URL æ ¼å¼
   - æå–è¯ä¹¦ã€å¯†é’¥ç­‰å‚æ•°


## é¡¹ç›®ç»“æ„

```
tsctl/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ tsctl/
â”‚   â”‚   â””â”€â”€ main.go              # tsctl CLI å…¥å£
â”‚   â”œâ”€â”€ guest/
â”‚   â”‚   â””â”€â”€ main.go              # guest agent å…¥å£
â”‚   â””â”€â”€ connector/
â”‚       â””â”€â”€ main.go              # mTLS è¿æ¥å™¨ï¼ˆè®¡åˆ’ä¸­ï¼‰
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ tsctl/
â”‚   â”‚   â”œâ”€â”€ start.go             # start å­å‘½ä»¤å®ç°
â”‚   â”‚   â””â”€â”€ host_exec.go         # host-exec å­å‘½ä»¤å®ç°
â”‚   â”œâ”€â”€ guest/
â”‚   â”‚   â”œâ”€â”€ server.go            # HTTP æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ command.go           # å‘½ä»¤æ‰§è¡Œå¤„ç†
â”‚   â”‚   â””â”€â”€ copy.go              # æ–‡ä»¶æ‹·è´å¤„ç†
â”‚   â”œâ”€â”€ docker-proxy/
â”‚   â”‚   â”œâ”€â”€ proxy.go             # ä»£ç†æ ¸å¿ƒ
â”‚   â”‚   â”œâ”€â”€ port_forward.go      # ç«¯å£è½¬å‘ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ file_sync.go         # æ–‡ä»¶åŒæ­¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ssh_client.go        # SSH å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ types.go             # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ ts-tunnel/
â”‚       â”œâ”€â”€ url.go               # URL è§£æ
â”‚       â”œâ”€â”€ agent-transport/
â”‚       â”‚   â”œâ”€â”€ transport.go     # Transport å®ç°
â”‚       â”‚   â””â”€â”€ tls.go           # TLS é…ç½®
â”‚       â”œâ”€â”€ forwarding-protocol/
â”‚       â”‚   â””â”€â”€ protocol.go      # è½¬å‘åè®®å¤„ç†å™¨
â”‚       â””â”€â”€ synchronization-protocol/
â”‚           â””â”€â”€ protocol.go      # åŒæ­¥åè®®å¤„ç†å™¨
â””â”€â”€ bin/
    â”œâ”€â”€ tsctl                    # ç¼–è¯‘è¾“å‡º
    â”œâ”€â”€ guest                    # ç¼–è¯‘è¾“å‡º
    â””â”€â”€ guest-linux              # Linux ç¼–è¯‘è¾“å‡º
```

## å¼€å‘è®¡åˆ’

### å·²å®Œæˆ
- âœ… åŸºç¡€ TCP ä»£ç†å’Œ HTTP è§£æ
- âœ… SSH ä¼ è¾“æ”¯æŒ
- âœ… è‡ªåŠ¨ç«¯å£è½¬å‘ï¼ˆåŸºäº Mutagenï¼‰
- âœ… è‡ªåŠ¨æ–‡ä»¶åŒæ­¥ï¼ˆåŸºäº Mutagenï¼‰
- âœ… TS-Tunnel (mTLS) ä¼ è¾“åè®®
- âœ… Guest agent æœåŠ¡
- âœ… æœåŠ¡ç«¯ mTLS connector ç»„ä»¶
- âœ… å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… è¿æ¥å‡çº§æ”¯æŒï¼ˆattach, execï¼‰
- âœ… ä¼˜é›…åœæœº

### è¿›è¡Œä¸­
- ğŸ”„ å®¢æˆ·ç«¯ daemon åŠ CLI ç»„ä»¶ï¼ˆäºŒè€…éœ€é€šä¿¡ï¼Œéœ€è·¨å¹³å°ï¼‰

